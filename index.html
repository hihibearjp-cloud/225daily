<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ç®¡ç­ç´š</title>

  <!-- PWA è¨­å®š -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#5D4037">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root{--coffee:#5D4037;--bg:#FEF9F2}
    *{box-sizing:border-box}
    body{font-family:'ZCOOL KuaiLe',sans-serif;background:var(--bg);margin:0;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:1.4rem}
    .card{background:#fff;border:3px solid var(--coffee);border-radius:12px;padding:12px;margin-top:12px;box-shadow:4px 4px 0 rgba(0,0,0,0.04)}
    .row{display:flex;gap:8px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .btn{border:3px solid var(--coffee);padding:8px 12px;border-radius:12px;background:#fff;cursor:pointer;font-weight:700}
    .btn.big{padding:12px 16px;font-size:1rem}
    .btn.primary{background:#CDF0EA}
    .btn.warn{background:#FDFD96}
    .badge{background:var(--coffee);color:#fff;padding:4px 8px;border-radius:999px;font-weight:800}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
    .student{border:2px dashed #ccc;border-radius:8px;padding:6px;background:#fff;display:flex;justify-content:space-between;align-items:center}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal .box{background:#fff;padding:12px;border-radius:12px;width:100%;max-width:520px;max-height:85vh;overflow:auto;border:3px solid var(--coffee)}
    .list-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    textarea,input,select{width:100%;padding:8px;border:2px solid var(--coffee);border-radius:8px}
    .small{font-size:0.85rem}
    footer{margin-top:24px;font-size:0.8rem;color:#666}
    @media(max-width:600px){ .list-grid{grid-template-columns:repeat(3,1fr)} h1{font-size:1.1rem} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ğŸ“š ç®¡ç­ç´š</h1>
        <div class="small" id="subtitle"></div>
      </div>
      <div class="row">
        <button class="btn" id="backupBtn">å‚™ä»½ JSON</button>
        <input id="restoreFile" type="file" accept=".json" style="display:none">
        <button class="btn" id="restoreBtn">é‚„åŸ JSON</button>
      </div>
    </header>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div style="flex:1;max-width:360px">
          <label class="small">æ—¥æœŸ</label>
          <input type="date" id="dateInput" />
        </div>
        <div style="flex:1;max-width:240px">
          <label class="small">é€±æ¬¡ / å€¼æ—¥</label>
          <input id="weekInput" placeholder="ä¾‹ï¼š2é€± / å¹¹éƒ¨: ç‹å°æ˜" />
        </div>
        <div style="flex-basis:180px;text-align:right">
          <label class="small">&nbsp;</label><br/>
          <button class="btn big" id="exportCsvBtn">åŒ¯å‡ºä»Šæ—¥ CSV</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ”” åˆ°æ ¡ç‹€æ³</h3>
      <div class="grid" id="attendanceBtns"></div>
    </div>

    <div class="card">
      <h3>ğŸ“˜ ä½œæ¥­ / è¯çµ¡ç°¿</h3>
      <div class="row wrap" id="missingBtns"></div>
      <div style="margin-top:8px">
        <label class="small">ç§‘ç›®åˆ—è¡¨ï¼ˆä¸€è¡Œä¸€å€‹ï¼‰</label>
        <textarea id="bulkSubject" rows="3" placeholder="åœ‹æ–‡&#10;æ•¸å­¸"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="addSubjectBtn">æ–°å¢ç§‘ç›®</button>
          <button class="btn" id="resetSubjectsBtn">é‡ç½®é è¨­ç§‘ç›®</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>ğŸ‘¥ å­¸ç”Ÿåå–®</h3>
        <div class="row">
          <button class="btn" id="bulkImportBtn">æ‰¹æ¬¡åŒ¯å…¥å§“å</button>
          <button class="btn" id="resetStudentsBtn">æ¢å¾©é è¨­ (30 äºº)</button>
        </div>
      </div>

      <div style="margin-top:8px" id="studentsContainer"></div>
    </div>

    <footer>
      æç¤ºï¼šæŠŠæ‰€æœ‰æª”æ¡ˆä¸Šå‚³åˆ° GitHubï¼Œå•Ÿç”¨ GitHub Pages å³å¯è®Šæˆ Appï¼
    </footer>
  </div>

  <div id="modalRoot"></div>

  <script>
    const DB_KEY = 'classlog_simple_v1';
    const DEFAULT_SUBJECTS = ['åœ‹æ–‡','è‹±èª','æ•¸å­¸','ç†åŒ–','ç¤¾æœƒ'];
    const ATTENDANCE_TYPES = [
      { id:'late', label:'é²åˆ°', color:'#FDFD96' },
      { id:'sick', label:'ç—…å‡', color:'#CDF0EA' },
      { id:'official', label:'å…¬å‡', color:'#C4E4FF' },
      { id:'personal', label:'äº‹å‡', color:'#E2C4FF' },
      { id:'absent', label:'ç¼ºå¸­', color:'#FFC4C4' }
    ];
    let state = {
      date: null,
      week: '',
      students: Array.from({length:30}, (_,i)=>({id:i+1,name:`${i+1}è™Ÿ`})),
      subjects: [...DEFAULT_SUBJECTS],
      attendance: {},
      missing: {}
    };

    const $ = (sel)=>document.querySelector(sel);
    const el=(tag,props={},...children)=>{const d=document.createElement(tag);for(const k in props){if(k==='style')Object.assign(d.style,props[k]);else if(k.startsWith('on'))d.addEventListener(k.slice(2),props[k]);else d.setAttribute(k,props[k]);}children.forEach(c=>{if(typeof c==='string')d.appendChild(document.createTextNode(c));else if(c)d.appendChild(c);});return d;}

    function loadState(){
      try{
        const raw=localStorage.getItem(DB_KEY);
        if(raw){state={...state,...JSON.parse(raw)};}
      }catch(e){}
      if(!state.date){
        const d=new Date();
        const off=d.getTimezoneOffset()*60000;
        state.date=new Date(d.getTime()-off).toISOString().split('T')[0];
      }
    }
    function saveState(){localStorage.setItem(DB_KEY,JSON.stringify(state));render();}

    function render(){
      $('#dateInput').value=state.date;
      $('#weekInput').value=state.week||'';
      $('#subtitle').textContent=state.date;

      const attRoot=$('#attendanceBtns'); attRoot.innerHTML='';
      ATTENDANCE_TYPES.forEach(t=>{
        const count=(state.attendance[t.id]||[]).length;
        const b=el('button',{class:'btn',style:{background:t.color},onClick:()=>openSelector('attendance',t.id,t.label)},t.label,el('span',{class:'badge'},count));
        attRoot.appendChild(b);
      });

      const missingRoot=$('#missingBtns'); missingRoot.innerHTML='';
      const contactTypes=['è¯çµ¡ç°¿ç¼ºäº¤','å®¶é•·æœªç°½å','è¯çµ¡ç°¿å„ªè‰¯'];
      contactTypes.concat(state.subjects).forEach((label,idx)=>{
        const id='m_'+idx;
        const count=(state.missing[id]||[]).length;
        const b=el('button',{class:'btn',onClick:()=>openSelector('missing',id,label)},label,el('span',{class:'badge',style:{marginLeft:'8px'}},count));
        missingRoot.appendChild(b);
      });

      const sc=$('#studentsContainer'); sc.innerHTML='';
      state.students.forEach(s=>{
        sc.appendChild(
          el('div',{class:'student'},
            el('div',{},`${s.id}. ${s.name}`),
            el('button',{class:'btn',onClick:()=>editStudentName(s.id)},'ç·¨è¼¯')
          )
        );
      });
    }

    function openSelector(type,key,label){
      const modalRoot=$('#modalRoot'); modalRoot.innerHTML='';
      modalRoot.appendChild(
        el('div',{class:'modal'},
          el('div',{class:'box'},
            el('div',{},el('strong',{},label),el('button',{class:'btn',style:{float:'right'},onClick:closeModal},'å®Œæˆ')),
            el('div',{style:{height:'12px'}}),
            el('div',{class:'list-grid'},
              ...state.students.map(s=>{
                const selected=(type==='attendance'?state.attendance[key]||[]:state.missing[key]||[]).includes(s.id);
                return el('button',{
                  class:'btn',
                  style:{background:selected?'#5D4037':'#fff',color:selected?'#fff':'#000'},
                  onClick:()=>toggleMark(type,key,s.id)
                },`${s.id}. ${s.name}`);
              })
            )
          )
        )
      );
    }

    function closeModal(){ $('#modalRoot').innerHTML=''; saveState(); }

    function toggleMark(type,key,id){
      const arr=(type==='attendance'?state.attendance:state.missing)[key]||[];
      if(arr.includes(id))
        (type==='attendance'?state.attendance:state.missing)[key]=arr.filter(x=>x!==id);
      else
        (type==='attendance'?state.attendance:state.missing)[key]=[...arr,id];
      render();
    }

    function editStudentName(id){
      const s=state.students.find(x=>x.id===id);
      const name=prompt('ä¿®æ”¹å­¸ç”Ÿåç¨±',s.name);
      if(name!==null){s.name=name.trim()||s.name;saveState();}
    }

    function exportTodayCSV(){
      const d=state.date;
      let csv=`ç­ç´šæ—¥èªŒ,æ—¥æœŸ,${d}\n\n`;
      csv+='é¡åˆ¥,é …ç›®,å­¸ç”Ÿ\n';
      for(const t of ATTENDANCE_TYPES){
        const list=(state.attendance[t.id]||[]).map(id=>state.students.find(s=>s.id===id)?.name||id).join('ã€');
        if(list) csv+=`åˆ°æ ¡,${t.label},"${list}"\n`;
      }
      csv+='\nä½œæ¥­ç¼ºäº¤\n';
      Object.keys(state.missing).forEach(k=>{
        if(state.missing[k]?.length>0){
          const idx=Number(k.split('_')[1]);
          const label=['è¯çµ¡ç°¿ç¼ºäº¤','å®¶é•·æœªç°½å','è¯çµ¡ç°¿å„ªè‰¯'][idx] || state.subjects[idx-3] || k;
          const names=state.missing[k].map(id=>state.students.find(s=>s.id===id)?.name||id).join('ã€');
          csv+=`${label},ç¼ºäº¤,"${names}"\n`;
        }
      });
      const blob=new Blob([`\uFEFF${csv}`],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`ç­ç´šæ—¥èªŒ_${d}.csv`; a.click();
    }

    function backupJSON(){
      const data={version:'v1',timestamp:new Date().toISOString(),data:state};
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`backup_${state.date}.json`; a.click();
    }

    function restoreFromFile(f){
      const reader=new FileReader();
      reader.onload=e=>{
        try{
          const obj=JSON.parse(e.target.result);
          if(obj.data){state={...state,...obj.data};saveState();alert('é‚„åŸæˆåŠŸ');}
          else alert('æ ¼å¼éŒ¯èª¤');
        }catch{alert('è®€å–å¤±æ•—');}
      };
      reader.readAsText(f);
    }

    document.addEventListener('DOMContentLoaded',()=>{
      loadState();

      $('#dateInput').addEventListener('change',e=>{state.date=e.target.value;saveState();});
      $('#weekInput').addEventListener('input',e=>{state.week=e.target.value;saveState();});

      $('#bulkImportBtn').addEventListener('click',()=>{
        const txt=prompt('ä¸€è¡Œä¸€å€‹åå­—ï¼š',state.students.map(s=>s.name).join('\n'));
        if(txt!==null){
          const arr=txt.split('\n').map(x=>x.trim()).filter(Boolean);
          if(arr.length>0){
            state.students=arr.map((n,i)=>({id:i+1,name:n}));
            saveState();
          }
        }
      });

      $('#resetStudentsBtn').addEventListener('click',()=>{
        if(confirm('æ¢å¾©é è¨­ 30 äººï¼Ÿ')){
          state.students=Array.from({length:30},(_,i)=>({id:i+1,name:`${i+1}è™Ÿ`}));
          saveState();
        }
      });

      $('#addSubjectBtn').addEventListener('click',()=>{
        const txt=$('#bulkSubject').value.trim();
        if(txt){
          const arr=txt.split('\n').map(x=>x.trim()).filter(Boolean);
          state.subjects=[...state.subjects,...arr];
          $('#bulkSubject').value='';
          saveState();
        }
      });

      $('#resetSubjectsBtn').addEventListener('click',()=>{
        state.subjects=[...DEFAULT_SUBJECTS];
        saveState();
      });

      $('#exportCsvBtn').addEventListener('click',exportTodayCSV);

      $('#backupBtn').addEventListener('click',backupJSON);
      $('#restoreBtn').addEventListener('click',()=>$('#restoreFile').click());
      $('#restoreFile').addEventListener('change',e=>{
        const f=e.target.files[0]; if(f) restoreFromFile(f);
        e.target.value='';
      });

      render();

      // è¨»å†Š Service Workerï¼ˆPWA å¿…è¦ï¼‰
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('/225daily/service-worker.js');
      }
    });
  </script>
</body>
</html>
