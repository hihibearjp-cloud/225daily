<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç­ç´šå°ç®¡å®¶ V14.0</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- 1. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. å¼•å…¥ React æ ¸å¿ƒ (ä½¿ç”¨æœ€ç©©å®šçš„ CDN) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. å¼•å…¥ Babel è§£æå™¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');
        
        body {
            background-color: #FEF9F2;
            color: #5D4037;
            font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
            overscroll-behavior-y: none;
            user-select: none;
            margin: 0; padding: 0;
        }
        #root:empty {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; color: #5D4037;
        }
        #root:empty::after { content: 'ğŸš€ ç³»çµ±å•Ÿå‹•ä¸­...'; }
        
        /* 3D æŒ‰éˆ• */
        .btn-3d {
            transition: transform 0.05s, box-shadow 0.05s;
            border: 3px solid #5D4037;
            box-shadow: 4px 4px 0px #5D4037;
            border-radius: 16px; 
            font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            position: relative; cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .btn-3d:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #5D4037; }

        /* è¨­å®šæŒ‰éˆ• */
        .nav-btn-settings {
            background-color: #FF5252; color: white; border: 3px solid #5D4037;
            box-shadow: 0px 4px 0px #3E2723; transform: translateY(-10px); z-index: 50;
        }
        .nav-btn-settings.active {
            background-color: #FF1744; transform: translateY(-16px) scale(1.1);
            box-shadow: 0px 6px 0px #3E2723; border: 3px solid #FFF; outline: 3px solid #5D4037;
        }

        .input-hand {
            border: 3px solid #5D4037; border-radius: 12px; padding: 12px 16px; 
            background: #FFF; font-family: 'ZCOOL KuaiLe', cursive; outline: none; width: 100%;
            font-size: 1.1rem; user-select: text;
        }
        .input-hand:focus { box-shadow: 3px 3px 0px #5D4037; }
        
        .modal-scroll { max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* é¡è‰²é¡åˆ¥ */
        .bg-mint { background-color: #CDF0EA; }
        .bg-yellow { background-color: #FDFD96; }
        .bg-pink { background-color: #FFC4C4; }
        .bg-blue-soft { background-color: #C4E4FF; }
        .bg-orange-soft { background-color: #FFD8B1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- éŒ¯èª¤æ””æˆª -->
    <div id="error-box" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; text-align:center;">
        <h2 style="color:red; font-size:24px;">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
        <p id="error-msg"></p>
        <button onclick="localStorage.clear(); location.reload()" style="margin-top:20px; padding:10px 20px; background:#555; color:white; border-radius:8px;">é‡ç½®è³‡æ–™ (æ€¥æ•‘ç”¨)</button>
    </div>

    <script>
        window.onerror = function(msg, url, line) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('error-box').style.display = 'flex';
            document.getElementById('error-msg').innerText = msg + "\nLine: " + line;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 1. å…§å»º SVG åœ–ç¤º (æ‰‹åˆ»ç‰ˆï¼Œä¿è­‰ä¸ç¼ºåœ–) ---
        const Icons = {
            User: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            Clock: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            FileWarning: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
            Edit3: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>,
            List: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            FileSpreadsheet: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M8 13h2"></path><path d="M8 17h2"></path><path d="M14 13h2"></path><path d="M14 17h2"></path></svg>,
            Settings: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Check: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Plus: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Trash2: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
            Download: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            BookOpen: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>,
            HelpCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
            UserCog: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="18" cy="15" r="3"></circle><circle cx="9" cy="7" r="4"></circle><path d="M10 15H6a4 4 0 0 0-4 4v2"></path><path d="m21.7 16.4.9-.9"></path><path d="m15.3 10 .9.9"></path><path d="m21.7 13.6-.9.9"></path><path d="m15.3 19.9.9-.9"></path></svg>,
            Megaphone: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 11 18-5v12L3 14v-3z"></path><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"></path></svg>,
            Send: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>,
            ClipboardCopy: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
            PenTool: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 19 7-7 3 3-7 7-3-3z"></path><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="m2 2 7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>,
            AlertTriangle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
            Share: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>,
            MoreVertical: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>,
            LayoutGrid: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="14" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect></svg>,
            CheckCircle2: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>,
            MicOff: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>,
            MessageCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path></svg>,
            PackageX: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"></path><path d="m7.5 4.27 9 5.15"></path><polyline points="3.29 7 12 12 20.71 7"></polyline><line x1="12" y1="22" x2="12" y2="12"></line><path d="m17 13 5 5m-5 0 5-5"></path></svg>,
            Stethoscope: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4.8 2.3A.3.3 0 0 1 5 2h14a.3.3 0 0 1 .2.3v3.3a.3.3 0 0 1-.3.3H5a.3.3 0 0 1-.3-.3V2.3z"></path><path d="M6 5v5a6 6 0 0 0 12 0V5"></path><path d="M12 16v3"></path><circle cx="12" cy="21" r="2"></circle></svg>,
            Briefcase: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>,
            Palmtree: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M13 8c0-2.76-2.46-5-5.5-5S2 5.24 2 8h2l1-1 1 1h4"></path><path d="M13 7.14A5.82 5.82 0 0 1 16.5 6c3.04 0 5.5 2.24 5.5 5h-3l-1-1-1 1h-3"></path><path d="M5.89 9.71c-2.15 2.15-2.3 5.47-.35 7.43l4.24-4.25.7-.71 1.42 1.42-.71.71-4.24 4.24c1.96 1.96 5.28 1.8 7.42-.35"></path><path d="M11 15.5c.5 2.5-.17 4.5-1 6.5h4c2-5.5-.5-12-1-14"></path></svg>,
            Star: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
            Smartphone: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"></rect><path d="M12 18h.01"></path></svg>,
            Database: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>,
            Upload: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            Cloud: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M20.8 15a5.5 5.5 0 0 0-9-9 5.5 5.5 0 0 0-7.7 7.7"/></svg>
        };

        // --- è³‡æ–™åº«éµå (V14 ç¢ºä¿ä¹¾æ·¨) ---
        const DB_KEY = 'classLogDB_V14_Stable';

        // --- è¨­å®šé è¨­å€¼ ---
        const DEFAULT_SUBJECTS = [{id:'chinese',label:'åœ‹æ–‡'},{id:'english',label:'è‹±èª'},{id:'math',label:'æ•¸å­¸'},{id:'science',label:'ç†åŒ–'},{id:'civics',label:'å…¬æ°‘'},{id:'history',label:'æ­·å²'},{id:'geo',label:'åœ°ç†'}];
        const DEFAULT_BEHAVIORS = [{id:'item_missing',label:'ç‰©å“æœªå¸¶',icon:'PackageX',color:'bg-pink'},{id:'late_class',label:'æ™šé€²æ•™å®¤',icon:'Clock',color:'bg-yellow'},{id:'rude',label:'å°å¸«ä¸ç¦®è²Œ',icon:'MicOff',color:'bg-pink'},{id:'noise',label:'åµé¬§å¹²æ“¾',icon:'AlertCircle',color:'bg-pink'},{id:'chat',label:'èŠå¤©',icon:'MessageCircle',color:'bg-yellow'},{id:'note',label:'å‚³ç´™æ¢',icon:'FileWarning',color:'bg-yellow'},{id:'other_book',label:'çœ‹èª²å¤–æ›¸',icon:'BookOpen',color:'bg-yellow'},{id:'sleep',label:'æ‰“çŒç¡',icon:'Coffee',color:'bg-pink'},{id:'no_hw_cls',label:'ä½œæ¥­æœªäº¤',icon:'FileWarning',color:'bg-pink'},{id:'other',label:'å…¶ä»–',icon:'PenTool',color:'bg-blue-soft'}];
        const ATTENDANCE_TYPES = [{id:'late',label:'é²åˆ°',icon:Icons.Clock,color:'bg-yellow'},{id:'sick',label:'ç—…å‡',icon:Icons.Stethoscope,color:'bg-mint'},{id:'official',label:'å…¬å‡',icon:Icons.Briefcase,color:'bg-blue-soft'},{id:'personal',label:'äº‹å‡',icon:Icons.Palmtree,color:'bg-purple-soft'},{id:'other_leave',label:'å…¶ä»–',icon:Icons.HelpCircle,color:'bg-gray-200'},{id:'absent',label:'ç¼ºå¸­',icon:Icons.AlertCircle,color:'bg-pink'}];
        const CONTACT_BOOK_TYPES = [{id:'cb_missing',label:'è¯çµ¡ç°¿ç¼ºäº¤',icon:Icons.X,color:'bg-pink'},{id:'cb_no_sign',label:'å®¶é•·æœªç°½å',icon:Icons.PenTool,color:'bg-yellow'},{id:'cb_good',label:'è¯çµ¡ç°¿å„ªè‰¯',icon:Icons.Star,color:'bg-mint'}];
        const PERIODS = [{id:'early',label:'æ—©ä¿®'},{id:'p1',label:'ç¬¬ä¸€ç¯€'},{id:'p2',label:'ç¬¬äºŒç¯€'},{id:'p3',label:'ç¬¬ä¸‰ç¯€'},{id:'p4',label:'ç¬¬å››ç¯€'},{id:'lunch',label:'åˆé¤'},{id:'nap',label:'åˆä¼‘'},{id:'p5',label:'ç¬¬äº”ç¯€'},{id:'p6',label:'ç¬¬å…­ç¯€'},{id:'p7',label:'ç¬¬ä¸ƒç¯€'},{id:'p8',label:'ç¬¬å…«ç¯€'}];
        const ICON_MAP = { PackageX: Icons.PackageX, Clock: Icons.Clock, MicOff: Icons.MicOff, AlertCircle: Icons.AlertCircle, MessageCircle: Icons.MessageCircle, FileWarning: Icons.FileWarning, BookOpen: Icons.BookOpen, Coffee: Icons.Coffee, HelpCircle: Icons.HelpCircle, PenTool: Icons.PenTool };

        // --- å­¸ç”Ÿé¸æ“‡å™¨å…ƒä»¶ ---
        const StudentSelectorModal = ({ isOpen, onClose, students, selectedList, title, onToggle }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" style={{zIndex: 9999}}>
                    <div className="bg-[#FEF9F2] w-full max-w-sm rounded-2xl border-4 border-[#5D4037] shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                        <div className="bg-yellow p-4 border-b-4 border-[#5D4037] flex justify-between items-center">
                            <h3 className="text-2xl font-bold text-[#5D4037]">é»é¸å­¸ç”Ÿ</h3>
                            <button onClick={onClose} className="bg-white p-2 rounded-full border-2 border-[#5D4037]"><Icons.CheckCircle2/></button>
                        </div>
                        <div className="bg-yellow px-4 pb-2 text-[#5D4037] font-bold opacity-80 border-b-2 border-[#5D4037] mb-2">æ­£åœ¨ç™»è¨˜ï¼š{title}</div>
                        <div className="p-4 overflow-y-auto grid grid-cols-4 gap-3 modal-scroll">
                            {students.map(s => (
                                <button key={s.id} onClick={() => onToggle(s.id)} className={`p-2 rounded-xl border-2 border-[#5D4037] font-bold text-base flex flex-col items-center justify-center transition-all min-h-[70px] ${selectedList.includes(s.id) ? 'bg-[#5D4037] text-white transform scale-95 shadow-inner' : 'bg-white text-[#5D4037] hover:bg-gray-100'}`}>
                                    <span className="text-sm opacity-70 mb-1">#{s.id}</span>
                                    <span className="truncate w-full text-center text-lg">{s.name}</span>
                                </button>
                            ))}
                        </div>
                        <div className="p-4 bg-white border-t-4 border-[#5D4037] text-center"><button onClick={onClose} className="btn-3d w-full bg-mint py-4 text-2xl text-[#5D4037]">å®Œ æˆ</button></div>
                    </div>
                </div>
            );
        };

        // --- ä¸»ç¨‹å¼ ---
        function App() {
            const [activeTab, setActiveTab] = useState('basic');
            const [currentDate, setCurrentDate] = useState(() => {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                return new Date(now.getTime() - offset).toISOString().split('T')[0];
            });

            const safeLoad = (key, defaultVal) => {
                try { const saved = localStorage.getItem(key); return saved ? JSON.parse(saved) : defaultVal; } catch { return defaultVal; }
            };

            const [db, setDb] = useState(() => safeLoad(DB_KEY, {}));
            const [saveStatus, setSaveStatus] = useState('idle');
            const [subjects, setSubjects] = useState(() => safeLoad('classLogSubjects', DEFAULT_SUBJECTS));
            const [behaviors, setBehaviors] = useState(() => safeLoad('classLogBehaviors', DEFAULT_BEHAVIORS));
            const [students, setStudents] = useState(() => safeLoad('classLogStudents', Array.from({ length: 30 }, (_, i) => ({ id: i + 1, name: `${i + 1}è™Ÿ` }))));
            const [teacherNote, setTeacherNote] = useState(() => safeLoad('classLogTeacherNote', ''));

            const todayData = useMemo(() => {
                const data = db[currentDate] || {};
                return {
                    week: data.week || '', dutyOfficer: data.dutyOfficer || '', dutyStudent: data.dutyStudent || '',
                    attendanceData: data.attendanceData || {}, missingData: data.missingData || {},
                    classLogData: data.classLogData || {}, periodNotes: data.periodNotes || {}, incidentLog: data.incidentLog || ''
                };
            }, [db, currentDate]);

            const updateToday = (field, value) => {
                setSaveStatus('saving');
                setDb(prevDb => {
                    const newDb = { ...prevDb, [currentDate]: { ...prevDb[currentDate], [field]: value } };
                    try { localStorage.setItem(DB_KEY, JSON.stringify(newDb)); setTimeout(() => setSaveStatus('saved'), 500); } catch { alert("å„²å­˜ç©ºé–“ä¸è¶³"); }
                    return newDb;
                });
            };

            useEffect(() => localStorage.setItem('classLogSubjects', JSON.stringify(subjects)), [subjects]);
            useEffect(() => localStorage.setItem('classLogBehaviors', JSON.stringify(behaviors)), [behaviors]);
            useEffect(() => localStorage.setItem('classLogStudents', JSON.stringify(students)), [students]);
            useEffect(() => localStorage.setItem('classLogTeacherNote', teacherNote), [teacherNote]);

            const [newSubjectName, setNewSubjectName] = useState('');
            const [isAddingSubject, setIsAddingSubject] = useState(false);
            const [newBehaviorName, setNewBehaviorName] = useState('');
            const [isEditingBehaviors, setIsEditingBehaviors] = useState(false);
            const [isSelectorOpen, setIsSelectorOpen] = useState(false);
            const [selectorConfig, setSelectorConfig] = useState({ type: '', category: '', period: '' });
            const [selectedStudentReport, setSelectedStudentReport] = useState(1);
            const [currentLogPeriod, setCurrentLogPeriod] = useState('p1');
            const [bulkNamesInput, setBulkNamesInput] = useState('');
            const [currentSubjectId, setCurrentSubjectId] = useState('');

            useEffect(() => { if (subjects.length > 0 && !currentSubjectId) setCurrentSubjectId(subjects[0].id); }, [subjects, currentSubjectId]);

            const toggleStudent = (studentId) => {
                const { type, category, period } = selectorConfig;
                if (type === 'attendance') {
                    const list = todayData.attendanceData[category] || [];
                    updateToday('attendanceData', { ...todayData.attendanceData, [category]: list.includes(studentId) ? list.filter(id => id !== studentId) : [...list, studentId] });
                } else if (type === 'missing') {
                    const list = todayData.missingData[category] || [];
                    updateToday('missingData', { ...todayData.missingData, [category]: list.includes(studentId) ? list.filter(id => id !== studentId) : [...list, studentId] });
                } else if (type === 'log') {
                    const periodData = todayData.classLogData[period] || {};
                    const list = periodData[category] || [];
                    updateToday('classLogData', { ...todayData.classLogData, [period]: { ...periodData, [category]: list.includes(studentId) ? list.filter(id => id !== studentId) : [...list, studentId] } });
                }
            };

            const getSelectedList = () => {
                const { type, category, period } = selectorConfig;
                if (type === 'attendance') return todayData.attendanceData[category] || [];
                if (type === 'missing') return todayData.missingData[category] || [];
                if (type === 'log') return todayData.classLogData[period]?.[category] || [];
                return [];
            };

            const updatePeriodNote = (val) => { updateToday('periodNotes', { ...todayData.periodNotes, [currentLogPeriod]: val }); };

            const handleBulkImportNames = () => {
                if (!bulkNamesInput.trim()) return;
                const names = bulkNamesInput.split(/\n/).map(n => n.trim()).filter(n => n);
                if (confirm(`å³å°‡åŒ¯å…¥ ${names.length} ä½å­¸ç”Ÿï¼Ÿ`)) { setStudents(names.map((name, index) => ({ id: index + 1, name: name }))); setBulkNamesInput(''); alert('åŒ¯å…¥æˆåŠŸï¼'); }
            };
            const handleUpdateStudentName = (id, newName) => setStudents(students.map(s => s.id === id ? { ...s, name: newName } : s));
            const handleAddSubject = () => { if (newSubjectName.trim()) { const newId = `sub_${Date.now()}`; setSubjects([...subjects, { id: newId, label: newSubjectName.trim() }]); setNewSubjectName(''); setIsAddingSubject(false); setCurrentSubjectId(newId); } };
            const handleDeleteSubject = (id, e) => { e.stopPropagation(); if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç§‘ç›®ï¼Ÿ')) setSubjects(subjects.filter(s => s.id !== id)); };
            const handleAddBehavior = () => { if (newBehaviorName.trim()) { const colors = ['bg-pink', 'bg-yellow', 'bg-mint', 'bg-blue-soft']; setBehaviors([...behaviors, { id: `beh_${Date.now()}`, label: newBehaviorName.trim(), icon: 'AlertCircle', color: colors[Math.floor(Math.random() * colors.length)] }]); setNewBehaviorName(''); } };
            const handleDeleteBehavior = (id, e) => { e.stopPropagation(); if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) setBehaviors(behaviors.filter(b => b.id !== id)); };
            const handleBehaviorClick = (behaviorId) => { if (isEditingBehaviors) return; if (behaviorId === 'other') { const note = prompt(`è«‹è¼¸å…¥ ${PERIODS.find(p=>p.id===currentLogPeriod)?.label} çš„å…¶ä»–èªªæ˜ï¼š`, todayData.periodNotes[currentLogPeriod] || ''); if (note !== null) updatePeriodNote(note); openSelector('log', behaviorId, currentLogPeriod); } else { openSelector('log', behaviorId, currentLogPeriod); } };
            const openSelector = (type, category, period = null) => { setSelectorConfig({ type, category, period }); setIsSelectorOpen(true); };
            const handleBackupData = () => { const backupData = { version: '14.0', timestamp: new Date().toISOString(), allData: db, settings: { subjects, behaviors, students, teacherNote } }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData)); const link = document.createElement('a'); link.href = dataStr; link.download = `ç­ç´šå°ç®¡å®¶_å‚™ä»½_${currentDate}.json`; link.click(); };
            const handleRestoreData = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const backup = JSON.parse(event.target.result); if (confirm(`ç¢ºå®šè¦é‚„åŸè³‡æ–™å—ï¼Ÿ`)) { if (backup.allData) { setDb(backup.allData); localStorage.setItem(DB_KEY, JSON.stringify(backup.allData)); } if (backup.settings) { if (backup.settings.subjects) setSubjects(backup.settings.subjects); if (backup.settings.behaviors) setBehaviors(backup.settings.behaviors); if (backup.settings.students) setStudents(backup.settings.students); if (backup.settings.teacherNote) setTeacherNote(backup.settings.teacherNote); } alert('âœ… é‚„åŸæˆåŠŸï¼'); } } catch { alert('âŒ æª”æ¡ˆéŒ¯èª¤'); } }; reader.readAsText(file); event.target.value = ''; };
            const downloadCSV = (content, filename) => { const bom = '\uFEFF'; const blob = new Blob([bom + content], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; link.click(); };

            const getWeeklyStats = (studentId) => {
                const dates = []; const today = new Date(currentDate);
                for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - i); dates.push(d.toISOString().split('T')[0]); }
                let stats = { attendance: {}, missing: {}, behavior: {} };
                let detailedBehaviors = [], detailedAttendance = [], detailedMissing = [];
                dates.forEach(date => {
                    const data = db[date]; if (!data) return;
                    const dateStr = date.slice(5).replace('-','/');
                    if (data.attendanceData) Object.keys(data.attendanceData).forEach(k => { if (data.attendanceData[k]?.includes(studentId)) { stats.attendance[k] = (stats.attendance[k] || 0) + 1; const type = ATTENDANCE_TYPES.find(t => t.id === k); detailedAttendance.push(`${dateStr} ${type ? type.label : k}`); } });
                    if (data.missingData) Object.keys(data.missingData).forEach(k => { if (data.missingData[k]?.includes(studentId)) { let label = k; const sub = subjects.find(s => s.id === k); const cb = CONTACT_BOOK_TYPES.find(c => c.id === k); if (sub) label = sub.label + 'ä½œæ¥­ç¼ºäº¤'; if (cb) label = cb.label; stats.missing[label] = (stats.missing[label] || 0) + 1; detailedMissing.push(`${dateStr} ${label}`); } });
                    if (data.classLogData) Object.keys(data.classLogData).forEach(periodId => { const pLog = data.classLogData[periodId]; const pNote = data.periodNotes?.[periodId]; if (pLog) { Object.keys(pLog).forEach(bId => { if (pLog[bId]?.includes(studentId)) { const b = behaviors.find(be => be.id === bId); let label = b ? b.label : 'å…¶ä»–'; let displayLabel = label; if (bId === 'other') { if (pNote) displayLabel = pNote; else displayLabel = "å…¶ä»–é•è¦"; } else { if (pNote) displayLabel = `${label} (${pNote})`; } const periodLabel = PERIODS.find(p => p.id === periodId)?.label || periodId; stats.behavior[label] = (stats.behavior[label] || 0) + 1; detailedBehaviors.push(`${dateStr} ${periodLabel}ï¼š${displayLabel}`); } }); } });
                });
                return { dates, stats, detailedBehaviors: detailedBehaviors.reverse(), detailedAttendance: detailedAttendance.reverse(), detailedMissing: detailedMissing.reverse() };
            };
            
            const exportWholeClassWeekly = () => { const dates = []; const today = new Date(currentDate); for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - i); dates.push(d.toISOString().split('T')[0]); } const dateRange = `${dates[dates.length-1]} ~ ${dates[0]}`; let csv = `å…¨ç­é€±å ±è¡¨\nçµ±è¨ˆç¯„åœ,${dateRange}\n\n`; csv += `åº§è™Ÿ,å§“å,ç¼ºå‹¤ç¸½æ•¸,ç¼ºäº¤ç¸½æ•¸,é•è¦ç¸½æ•¸,ç¼ºå‹¤æ˜ç´°,ç¼ºäº¤æ˜ç´°,é•è¦æ˜ç´°\n`; students.forEach(student => { const { stats, detailedBehaviors, detailedAttendance, detailedMissing } = getWeeklyStats(student.id); const totalAtt = Object.values(stats.attendance).reduce((a,b) => a+b, 0); const totalMiss = Object.values(stats.missing).reduce((a,b) => a+b, 0); const totalBeh = Object.values(stats.behavior).reduce((a,b) => a+b, 0); csv += `${student.id},${student.name},${totalAtt},${totalMiss},${totalBeh},"${detailedAttendance.join('ï¼›')}","${detailedMissing.join('ï¼›')}","${detailedBehaviors.join('ï¼›')}"\n`; }); downloadCSV(csv, `å…¨ç­é€±å ±è¡¨_${currentDate}.csv`); };
            const exportStudentWeekly = () => { const s = students.find(s => s.id === selectedStudentReport); if(!s) return alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿ'); const { dates, stats } = getWeeklyStats(selectedStudentReport); let csv = `å­¸ç”Ÿå€‹åˆ¥é€±å ±è¡¨\nåº§è™Ÿ,${s.id}\nå§“å,${s.name}\nçµ±è¨ˆç¯„åœ,${dates[dates.length-1]} ~ ${dates[0]}\n\n`; csv += `é¡åˆ¥,é …ç›®,æ¬¡æ•¸\n`; Object.entries(stats.attendance).forEach(([k, v]) => csv += `ç¼ºå‹¤,${ATTENDANCE_TYPES.find(t=>t.id===k)?.label||k},${v}\n`); Object.entries(stats.missing).forEach(([k, v]) => csv += `ç¼ºäº¤,${k},${v}\n`); Object.entries(stats.behavior).forEach(([k, v]) => csv += `é•è¦,${k},${v}\n`); downloadCSV(csv, `${s.name}_é€±å ±è¡¨.csv`); };
            const exportDailyLog = () => { let csv = `ç­ç´šæ—¥èªŒ,æ—¥æœŸï¼š${currentDate},é€±æ¬¡ï¼š${todayData.week},å€¼æ—¥ï¼š${todayData.dutyOfficer}/${todayData.dutyStudent}\n\n`; csv += `ã€åˆ°æ ¡ã€‘\né¡åˆ¥,å­¸ç”Ÿ\n`; ATTENDANCE_TYPES.forEach(t => { const list = todayData.attendanceData[t.id]?.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€') || ''; if(list) csv += `${t.label},"${list}"\n`; }); csv += `\nã€ä½œæ¥­ã€‘\né …ç›®,ç¼ºäº¤\n`; const getMissingNames = (list) => list?.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€') || ''; CONTACT_BOOK_TYPES.forEach(t => { const str = getMissingNames(todayData.missingData[t.id]); if(str) csv += `${t.label},"${str}"\n`; }); subjects.forEach(s => { const str = getMissingNames(todayData.missingData[s.id]); if(str) csv += `${s.label}ç¼ºäº¤,"${str}"\n`; }); csv += `\nã€èª²å ‚ã€‘\næ™‚æ®µ,è¡Œç‚º,å­¸ç”Ÿ,å‚™è¨»\n`; PERIODS.forEach(p => { const logs = todayData.classLogData[p.id]; const note = todayData.periodNotes[p.id] || ''; if (logs) { behaviors.forEach(b => { const rawList = logs[b.id]; if (rawList && rawList.length > 0) { const names = rawList.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('ã€'); csv += `${p.label},${b.label},"${names}","${note}"\n`; } }); } if ((!logs || Object.keys(logs).every(k => logs[k].length === 0)) && note) { csv += `${p.label},å‚™è¨»,,"${note}"\n`; } }); csv += `\nã€å¶ç™¼ã€‘\n"${todayData.incidentLog.replace(/"/g, '""')}"\n`; downloadCSV(csv, `ç­ç´šæ—¥èªŒ_${currentDate}.csv`); };
            const generateParentMessage = (studentId) => { const s = students.find(stud => stud.id === studentId); if (!s) return "è«‹å…ˆé¸æ“‡å­¸ç”Ÿ..."; const { dates, stats, detailedBehaviors, detailedAttendance, detailedMissing } = getWeeklyStats(studentId); const dateRange = `${dates[dates.length-1].slice(5).replace('-','/')} ~ ${dates[0].slice(5).replace('-','/')}`; let msg = ""; if (teacherNote.trim()) { msg += `ğŸ“¢ â­â­â­ é‡è¦é€šçŸ¥ â­â­â­\n${teacherNote}\n\n------------------------------\n\n`; } msg += `ã€ç­ç´šé€±å ±ã€‘è¦ªæ„›çš„å®¶é•·æ‚¨å¥½ï¼Œé€™æ˜¯ ${s.name} æœ¬é€± (${dateRange}) çš„åœ¨æ ¡è¡¨ç¾æ‘˜è¦ï¼š\n\n`; if (detailedAttendance.length > 0) { msg += `ğŸ“… è€ƒå‹¤ç´€éŒ„ï¼š\n`; detailedAttendance.forEach(item => { msg += `   - ${item}\n`; }); } else { msg += `ğŸ“… è€ƒå‹¤ç´€éŒ„ï¼šå…¨å‹¤ ğŸ‘\n`; } if (detailedMissing.length > 0) { msg += `ğŸ“š ä½œæ¥­èˆ‡ç‰©å“ï¼š\n`; detailedMissing.forEach(item => { msg += `   - ${item}\n`; }); } else { msg += `ğŸ“š ä½œæ¥­ç¹³äº¤ï¼šç‹€æ³è‰¯å¥½ ğŸ‘\n`; } if (detailedBehaviors.length > 0) { msg += `âš ï¸ èª²å ‚å¸¸è¦æé†’ï¼š\n`; detailedBehaviors.forEach(item => { msg += `   - ${item}\n`; }); } else { msg += `âœ¨ èª²å ‚è¡¨ç¾ï¼šéµå®ˆå¸¸è¦ï¼Œè¡¨ç¾ç©©å®šã€‚\n`; } msg += `\nå†è«‹æ‚¨å”åŠ©é—œå¿ƒå­©å­çš„å­¸ç¿’ç‹€æ³ï¼Œè¬è¬æ‚¨çš„é…åˆï¼`; return msg; };
            const handleLineShare = (text) => { const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`; window.open(lineUrl, '_blank'); };
            const copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½è¨Šæ¯ï¼')); };

            // --- Renders ---
            const renderBasicInfo = () => (
                <div className="space-y-6 pb-24">
                    <div className="doodle-card p-5 bg-white space-y-4">
                        <div className="flex gap-3"><div className="flex-1"><label className="text-gray-500 font-bold text-sm">æ—¥æœŸ</label><input type="date" value={currentDate} onChange={e => setCurrentDate(e.target.value)} className="input-hand" /></div><div className="w-1/3"><label className="text-gray-500 font-bold text-sm">é€±æ¬¡</label><input type="text" value={todayData.week} onChange={e => updateToday('week', e.target.value)} className="input-hand text-center" /></div></div>
                        <div className="flex gap-3"><div className="flex-1"><label className="text-gray-500 font-bold text-sm">å€¼æ—¥å¹¹éƒ¨</label><input type="text" value={todayData.dutyOfficer} onChange={e => updateToday('dutyOfficer', e.target.value)} className="input-hand" /></div><div className="flex-1"><label className="text-gray-500 font-bold text-sm">å€¼æ—¥ç”Ÿ</label><input type="text" value={todayData.dutyStudent} onChange={e => updateToday('dutyStudent', e.target.value)} className="input-hand" /></div></div>
                    </div>
                    <div className="doodle-card p-5 bg-white relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-4 bg-mint border-b-2 border-[#5D4037]"></div><h3 className="text-2xl font-bold mb-4 mt-2 flex items-center gap-2"><Icons.Clock /> åˆ°æ ¡ç‹€æ³</h3><div className="grid grid-cols-2 gap-4">{ATTENDANCE_TYPES.map(t => { const count = todayData.attendanceData[t.id]?.length || 0; const Icon = t.icon; return <button key={t.id} onClick={() => openSelector('attendance', t.id)} className={`btn-3d p-3 flex items-center justify-between px-4 ${t.color} text-lg h-14`}><div className="flex items-center gap-2"><Icon size={20}/><span>{t.label}</span></div>{count > 0 && <span className="bg-[#5D4037] text-white text-sm px-3 py-1 rounded-full">{count}</span>}</button> })}</div></div>
                    <div className="doodle-card p-5 bg-white relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-4 bg-yellow border-b-2 border-[#5D4037]"></div><h3 className="text-2xl font-bold mb-4 mt-2 flex items-center gap-2"><Icons.FileWarning /> ä½œæ¥­èˆ‡è¯çµ¡ç°¿</h3><div className="grid grid-cols-1 gap-3 mb-4">{CONTACT_BOOK_TYPES.map(t => { const count = todayData.missingData[t.id]?.length || 0; const Icon = t.icon; return <button key={t.id} onClick={() => openSelector('missing', t.id)} className={`btn-3d w-full py-3 flex justify-between px-5 text-lg ${t.color}`}><div className="flex items-center gap-3"><Icon size={22}/><span>{t.label}</span></div>{count > 0 && <span className="bg-[#5D4037] text-white text-sm px-3 py-1 rounded-full">{count}</span>}</button> })}</div>
                    <div className="border-t-2 border-[#5D4037] pt-4 space-y-4">
                        <div className="flex justify-between items-center"><h4 className="font-bold text-[#5D4037] text-lg">å„ç§‘ä½œæ¥­ç¼ºäº¤</h4><button onClick={() => setIsAddingSubject(!isAddingSubject)} className="text-sm bg-mint px-3 py-1 rounded-full border-2 border-[#5D4037]"><Icons.Plus size={16}/></button></div>
                        {isAddingSubject && <div className="flex gap-2"><input autoFocus type="text" value={newSubjectName} onChange={e => setNewSubjectName(e.target.value)} className="input-hand" /><button onClick={() => {if(newSubjectName){ const newId = `sub_${Date.now()}`; setSubjects([...subjects, {id: newId, label: newSubjectName}]); setNewSubjectName(''); setIsAddingSubject(false); setCurrentSubjectId(newId); }}} className="btn-3d px-4 bg-[#5D4037] text-white">OK</button></div>}
                        <div className="space-y-3"><div className="flex gap-2"><select value={currentSubjectId} onChange={(e) => setCurrentSubjectId(e.target.value)} className="input-hand flex-1 font-bold">{subjects.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select><button onClick={() => {if(confirm('åˆªé™¤?')) setSubjects(subjects.filter(s => s.id !== currentSubjectId))}} className="btn-3d bg-pink text-white px-3"><Icons.Trash2 /></button></div><button onClick={() => openSelector('missing', currentSubjectId)} className="btn-3d w-full bg-white py-4 text-lg flex justify-between px-5 border-2 border-[#5D4037]"><span className="font-bold flex items-center gap-2"><Icons.Edit3/> ç™»è¨˜ {subjects.find(s=>s.id===currentSubjectId)?.label} ç¼ºäº¤</span>{todayData.missingData[currentSubjectId]?.length > 0 ? <span className="bg-pink text-[#5D4037] px-3 py-1 rounded-full text-sm border border-[#5D4037]">{todayData.missingData[currentSubjectId].length}äºº</span> : <span className="text-gray-400 text-sm">é»æ“Šç™»è¨˜</span>}</button></div>
                        <div className="flex flex-col gap-2 mt-2">{subjects.map(s => { const list = todayData.missingData[s.id]; if(!list || list.length===0) return null; return <div key={s.id} className="bg-white border-2 border-[#5D4037] px-3 py-2 rounded-xl text-sm font-bold flex justify-between"><span>{s.label}</span><span className="text-[#5D4037] opacity-80">ç¼ºäº¤ï¼š{list.sort((a,b)=>a-b).join('ã€')}è™Ÿ</span></div> })}</div>
                    </div></div>
                </div>
            );

            const renderLog = () => (
                 <div className="space-y-5 pb-24">
                    <div className="doodle-card p-4 bg-white flex flex-col gap-3">
                        <div className="flex items-center gap-2"><label className="font-bold text-[#5D4037] text-xl shrink-0">æ™‚æ®µï¼š</label><select value={currentLogPeriod} onChange={(e) => setCurrentLogPeriod(e.target.value)} className="input-hand text-2xl font-bold bg-yellow border-2 border-[#5D4037] h-14 flex-1">{PERIODS.map(p => <option key={p.id} value={p.id}>{p.label}</option>)}</select></div>
                        <div className="relative"><input type="text" value={todayData.periodNotes[currentLogPeriod] || ''} onChange={(e) => updateToday('periodNotes', {...todayData.periodNotes, [currentLogPeriod]: e.target.value})} placeholder="è¼¸å…¥å‚™è¨»..." className="input-hand pr-10" /><Icons.PenTool className="absolute right-3 top-3 text-gray-400" /></div>
                    </div>
                    <div className="grid grid-cols-3 gap-3">{behaviors.map(b => { const count = todayData.classLogData[currentLogPeriod]?.[b.id]?.length || 0; const Icon = ICON_MAP[b.icon] || Icons.AlertCircle; return <button key={b.id} onClick={() => { if(b.id==='other'){const n=prompt('èªªæ˜:', todayData.periodNotes[currentLogPeriod]); if(n) updateToday('periodNotes', {...todayData.periodNotes, [currentLogPeriod]: n});} openSelector('log', b.id, currentLogPeriod); }} className={`btn-3d p-2 flex flex-col items-center gap-1 ${b.color} min-h-[90px] relative`}><Icon size={32} /><span className="text-lg">{b.label}</span>{count>0 && <span className="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs border border-[#5D4037]">{count}</span>}</button> })}</div>
                 </div>
            );

            const renderReports = () => (
                <div className="pb-24 space-y-6">
                    <div className="doodle-card p-5 bg-orange-soft border-4 border-white shadow-lg"><h3 className="font-bold mb-3 flex items-center gap-2 text-2xl text-[#5D4037]"><Icons.FileSpreadsheet/> æ•™å¸«å°ˆç”¨ï¼šé€±å ±è¡¨</h3><button onClick={exportWholeClassWeekly} className="w-full btn-3d bg-white py-4 text-[#5D4037] flex items-center justify-center gap-3 text-xl"><Icons.Download/> ä¸‹è¼‰å…¨ç­é€±å ±è¡¨</button></div>
                    <div className="doodle-card p-4 bg-white border-4 border-red-500 shadow-xl transform rotate-1"><h3 className="font-bold mb-2 text-2xl flex items-center gap-2 text-red-600 border-b-2 border-red-200 pb-2"><Icons.Megaphone size={32} className="animate-bounce"/> è€å¸«çš„è©±</h3><textarea value={teacherNote} onChange={(e) => setTeacherNote(e.target.value)} className="w-full h-32 p-3 border-2 border-red-200 rounded-xl outline-none text-xl font-bold text-[#5D4037] bg-red-50" placeholder="åœ¨æ­¤è¼¸å…¥é‡è¦äº‹é …..." /></div>
                    <div className="doodle-card p-5 bg-yellow flex justify-between items-center"><div className="flex gap-3 items-center"><Icons.User size={36}/><div><div className="text-sm opacity-60 font-bold">æŸ¥çœ‹å­¸ç”Ÿ</div><select value={selectedStudentReport} onChange={(e) => setSelectedStudentReport(Number(e.target.value))} className="bg-transparent text-2xl font-bold outline-none border-b-2 border-[#5D4037] min-w-[100px]">{students.map(s => <option key={s.id} value={s.id}>{s.id}. {s.name}</option>)}</select></div></div></div>
                    <div className="space-y-4"><div className="bg-white border-2 border-[#5D4037] p-4 rounded-xl text-lg whitespace-pre-wrap h-48 overflow-y-auto shadow-inner">{generateParentMessage(selectedStudentReport)}</div><div className="flex gap-3 items-stretch"><button onClick={() => handleLineShare(generateParentMessage(selectedStudentReport))} className="flex-[3] btn-3d bg-line text-white py-4 text-xl flex items-center justify-center gap-2 shadow-lg"><Icons.Send size={24} /> å‚³é€LINE</button><button onClick={() => copyToClipboard(generateParentMessage(selectedStudentReport))} className="flex-1 btn-3d bg-mint py-4 flex flex-col items-center justify-center gap-1 text-xs opacity-80"><Icons.ClipboardCopy size={24} /> <span>è¤‡è£½</span></button></div></div>
                </div>
            );

            const renderSettings = () => (
                <div className="pb-24 space-y-8">
                   <div className="doodle-card p-5 bg-dark border-4 border-[#5D4037]"><h3 className="text-2xl font-bold mb-4 text-white flex items-center gap-2"><Icons.Database/> å‚™ä»½èˆ‡é‚„åŸ</h3><div className="grid grid-cols-2 gap-4"><button onClick={handleBackupData} className="btn-3d bg-mint py-3 text-[#5D4037]">ä¸‹è¼‰å‚™ä»½</button><div className="relative"><input type="file" accept=".json" onChange={handleRestoreData} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" /><button className="btn-3d bg-yellow py-3 w-full text-[#5D4037]">é‚„åŸè³‡æ–™</button></div></div></div>
                   <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-[#5D4037] pb-3"><Icons.UserCog/> å­¸ç”Ÿåå–®</h3><div className="mb-6"><textarea className="input-hand h-32" placeholder="ç‹å°æ˜&#10;æå¤§åŒ" value={bulkNamesInput} onChange={(e) => setBulkNamesInput(e.target.value)} /><button onClick={handleBulkImportNames} className="mt-2 w-full btn-3d bg-yellow text-[#5D4037] py-3">åŒ¯å…¥åå–®</button></div></div>
                </div>
            );
            
            const renderManual = () => <div className="pb-24 p-5 text-center"><h2 className="text-3xl font-bold text-[#5D4037] mb-4">ğŸ“˜ ä½¿ç”¨èªªæ˜æ›¸</h2><p>è«‹å°‡ç¶²é åŠ å…¥ä¸»ç•«é¢ä»¥ç²å¾—æœ€ä½³é«”é©—ï¼</p></div>;
            const renderReview = () => <div className="pb-24 p-5"><div className="bg-white border-2 border-[#5D4037] p-4 min-h-[300px]"><h2 className="text-2xl font-bold text-center mb-4">ä»Šæ—¥æ—¥èªŒé è¦½</h2><p className="text-center text-gray-400">è«‹ä½¿ç”¨åŒ¯å‡ºåŠŸèƒ½æŸ¥çœ‹å®Œæ•´å…§å®¹</p></div></div>;

            return (
                <div className="min-h-screen w-full max-w-md mx-auto relative overflow-hidden">
                    <style>{customStyles}</style>
                    <header className="pt-8 pb-3 px-6 flex justify-between items-center"><h1 className="text-4xl font-bold text-[#5D4037] tracking-wider transform -rotate-1 flex items-center gap-3"><Icons.BookOpen size={40} strokeWidth={3} /> ç­ç´šæ—¥èªŒ</h1><button onClick={() => setActiveTab('manual')} className="bg-white p-2 rounded-full border-2 border-[#5D4037] shadow-sm"><Icons.HelpCircle size={28} className="text-[#5D4037]"/></button></header>
                    <main className="px-5 h-full pt-4">
                        {activeTab === 'basic' && renderBasicInfo()}
                        {activeTab === 'log' && renderLog()}
                        {activeTab === 'review' && renderReview()}
                        {activeTab === 'report' && renderReports()}
                        {activeTab === 'settings' && renderSettings()}
                        {activeTab === 'manual' && renderManual()}
                    </main>
                    {StudentSelectorModal({ isOpen: isSelectorOpen, onClose: () => setIsSelectorOpen(false), students, selectedList: getSelectedList(), title: selectorConfig.type === 'attendance' ? ATTENDANCE_TYPES.find(t => t.id === selectorConfig.category)?.label : selectorConfig.type === 'missing' ? (CONTACT_BOOK_TYPES.find(t => t.id === selectorConfig.category)?.label || subjects.find(s => s.id === selectorConfig.category)?.label + 'ç¼ºäº¤') : `${PERIODS.find(p => p.id === selectorConfig.period)?.label} - ${behaviors.find(b => b.id === selectorConfig.category)?.label}`, onToggle: toggleStudent })}
                    <nav className="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[98%] max-w-sm bg-[#FFF] border-3 border-[#5D4037] rounded-2xl shadow-[4px_4px_0px_#5D4037] flex justify-between px-3 py-3 z-40">
                        {[{ id: 'basic', icon: Icons.User, label: 'é»å', color: 'bg-mint' }, { id: 'log', icon: Icons.Edit3, label: 'ç´€éŒ„', color: 'bg-yellow' }, { id: 'review', icon: Icons.List, label: 'æ—¥èªŒ', color: 'bg-pink' }, { id: 'report', icon: Icons.FileSpreadsheet, label: 'å ±è¡¨', color: 'bg-blue-soft' }, { id: 'settings', icon: Icons.Settings, label: 'è¨­å®š', color: 'bg-red-alert' }].map(tab => ( <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 flex flex-col items-center p-2 rounded-xl transition-all duration-300 ${tab.id === 'settings' ? 'nav-btn-settings ' + (activeTab === 'settings' ? 'active' : '') : (activeTab === tab.id ? `${tab.color} -translate-y-4 border-2 border-[#5D4037] shadow-sm` : 'opacity-60')}`}><tab.icon size={32} className={tab.id === 'settings' ? 'text-white' : 'text-coffee'}/><span className={`text-xs font-black mt-1 ${tab.id === 'settings' ? 'text-white' : 'text-[#5D4037]'}`}>{tab.label}</span></button> ))}
                    </nav>
                </div>
            );
        }
